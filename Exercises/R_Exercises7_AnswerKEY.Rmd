---
title: "R Exercises Session 6"
author: "Introduction to R for Data Management and Analysis"
date: "Thursday, June 21, 2018"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Exercises


1. Take the `relig_income` dataset from the `tidyr` package (see `?data`) and
reshape it to get a tally of the number of participants by religous
affiliation.

```{r}
library(tidyr)
library(dplyr)

relig_income %>%
    pivot_longer(-religion, names_to = "income", values_to = "count") %>%
    group_by(religion) %>%
    summarize(totals = sum(count)) %>%
    arrange(-totals)
```

2. Use the `nycflights13` package to add columns to the `flights` dataset from
the `airports` dataset. Add two columns named `origin_name` and `dest_name`
that map correctly by the airport code `faa` and return the airport name.
Use the columns `origin` and destination (`dest`) from flights to do the
mapping.

```{r}
library(nycflights13)
## keep cols of interest in airports
airports2 <- select(airports, faa, name)

## Method 1
flights1 <- flights %>%
    left_join(airports2, by = c("origin" = "faa")) %>%
    rename(origin_name = name)
flights1 <- flights1 %>%
    left_join(airports2, by = c("dest" = "faa")) %>%
    rename(dest_name = name)

## Method 2
origins <- airports2$name[match(flights$origin, airports2$faa)]
dests <- airports2$name[match(flights$dest, airports2$faa)]

## make a copy of object so to not overwrite it
flights2 <- flights
flights2[, c("origin_name", "dest_name")] <-
    cbind.data.frame(origin_name = origins, dest_name = dests,
    ## argument to generate character vectors instead of factors
    stringsAsFactors = FALSE)
```

3. Add a new column to your dataset recoding the `month` variable to a factor
variable. Use the internal R vector `month.name` for your labels.

```{r}
table(flights1$month)
## Method 1
flights1$month2 <- factor(
    flights1$month, levels = 1:12, labels = month.name
)

## Method 2
flights1[["month2"]] <- factor(
    flights1$month, levels = 1:12, labels = month.name
)
```

4. What month and airport has the most flights?

```{r}
## Method 1
flights1 %>%
    group_by(month2, origin_name) %>%
    summarize(totals = n()) %>%
    arrange(-totals)

## Method 2
flights1 %>%
    group_by(month2, origin_name) %>%
    tally() %>%
    arrange(-n)

## Method 3
splitDF <- split(flights1, list(flights1$month2, flights1$origin_name))
tallies <- vapply(splitDF, nrow, numeric(1L))
head(tallies[order(tallies, decreasing = TRUE)], 10)

## Method 4
flights1[["COUNT"]] <- 1
agg_flights <- aggregate(COUNT ~ month2 + origin_name, data = flights1, FUN = sum)
head(agg_flights[order(agg_flights$COUNT, decreasing = TRUE), ], 10)
```

5. What is the average, minimum, and maximum yearly temperatures for all listed
airports in the `weather` dataset?

```{r}
weather
## Years in data
table(weather$year)

## Method 1
weather %>%
    group_by(origin) %>%
    summarize(
        avg_temp = mean(temp, na.rm = TRUE),
        min_temp = min(temp, na.rm = TRUE),
        max_temp = max(temp, na.rm = TRUE)
    )

## Method 2
aggregate(. ~ origin, data = weather[, c("temp", "origin")],
    FUN = function(x) {
        c(avg_temp = mean(x, na.rm = TRUE),
            min_temp = min(x, na.rm = TRUE),
            max_temp = max(x, na.rm = TRUE))
    }
)

## Method 3 (not covered in class)
library(purrr)
split(weather$temp, weather$origin) %>%
    map(function(x)
        c(avg_temp = mean(x, na.rm = TRUE),
        min_temp = min(x, na.rm = TRUE),
        max_temp = max(x, na.rm = TRUE))
    )
```
